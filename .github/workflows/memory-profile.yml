name: Memory Profiling

on:
  workflow_dispatch:
  pull_request:
    branches: [ main ]
    paths:
      - 'src/**/*.rs'
      - 'Cargo.toml'
      - 'Cargo.lock'

env:
  RUST_VERSION: "1.90.0"

jobs:
  bytehound-profile:
    name: ByteHound Memory Profile
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential gcc jq

    - name: Install Rust nightly (for ByteHound build)
      run: |
        rustup toolchain install nightly
        rustup default nightly

    - name: Clone and build ByteHound
      run: |
        git clone https://github.com/koute/bytehound.git /tmp/bytehound
        cd /tmp/bytehound
        cargo build --release -p bytehound-preload
        cargo build --release -p bytehound-cli

        # Copy binaries to accessible location
        cp target/release/libbytehound.so $HOME/
        cp target/release/bytehound $HOME/

    - name: Switch back to stable Rust
      run: rustup default stable

    - name: Build wsc tests
      run: cargo test --no-run --release

    - name: Run tests with ByteHound profiling
      run: |
        # Set LD_PRELOAD to the ByteHound library
        export LD_PRELOAD=$HOME/libbytehound.so
        export MEMORY_PROFILER_LOG=warn

        # Run a subset of tests or specific test
        cargo test --release -- --test-threads=1 --nocapture || true

        echo "ByteHound profiling data generated"
        ls -lh memory-profiling_*.dat || echo "No profiling data files found"

    - name: Upload profiling data
      if: success() || failure()
      uses: actions/upload-artifact@v4
      with:
        name: bytehound-profiles
        path: memory-profiling_*.dat
        retention-days: 7
        if-no-files-found: warn

    - name: Extract ByteHound metrics
      if: success() || failure()
      run: |
        # Check if any profiling data files exist
        if ls memory-profiling_*.dat 1> /dev/null 2>&1; then
          echo "Extracting metrics from ByteHound profiles..."

          # Process each profile file
          for profile in memory-profiling_*.dat; do
            echo ""
            echo "=== Analyzing: $profile ==="

            # Extract basic metrics using bytehound CLI
            # Note: These commands may vary based on ByteHound version

            # Try to get allocation statistics
            $HOME/bytehound allocations "$profile" --count 10 2>/dev/null | tee "${profile}.allocations.txt" || echo "Could not extract allocation stats"

            # Try to get memory timeline/summary
            $HOME/bytehound export "$profile" --format json --output "${profile}.json" 2>/dev/null || echo "Could not export to JSON"

            # If JSON export succeeded, extract key metrics
            if [ -f "${profile}.json" ]; then
              echo "Extracting metrics from JSON export..."

              # Use jq if available to parse metrics
              if command -v jq &> /dev/null; then
                echo "Peak memory usage:" $(jq -r '.peak_memory // "N/A"' "${profile}.json" 2>/dev/null || echo "N/A")
                echo "Total allocations:" $(jq -r '.total_allocations // "N/A"' "${profile}.json" 2>/dev/null || echo "N/A")
                echo "Total allocated:" $(jq -r '.total_allocated // "N/A"' "${profile}.json" 2>/dev/null || echo "N/A")
              else
                # Fallback: just show file size as rough metric
                echo "Profile size: $(stat -f%z "$profile" 2>/dev/null || stat -c%s "$profile" 2>/dev/null || echo "unknown")"
              fi
            fi
          done
        else
          echo "No profiling data files found"
        fi

    - name: Generate ByteHound summary
      if: success() || failure()
      run: |
        # Check if any profiling data files exist
        if ls memory-profiling_*.dat 1> /dev/null 2>&1; then
          echo "## ðŸ“Š ByteHound Memory Profile" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Memory profiling data has been collected." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Include extracted metrics if available
          if ls memory-profiling_*.dat.allocations.txt 1> /dev/null 2>&1; then
            echo "### ðŸ“ˆ Top Allocations" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            head -20 memory-profiling_*.dat.allocations.txt | head -20 >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "No allocation data available" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "### ðŸ“ Profile Files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          ls -lh memory-profiling_*.dat | awk '{print "- **" $9 "** - " $5}' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸ” Detailed Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download the \`bytehound-profiles\` artifact and run:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo 'bytehound server memory-profiling_*.dat' >> $GITHUB_STEP_SUMMARY
          echo '# Then open http://localhost:8080' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        else
          echo "## âš ï¸ ByteHound Memory Profile" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No memory profiling data was generated." >> $GITHUB_STEP_SUMMARY
          echo "This may indicate that ByteHound was not properly loaded or tests did not run." >> $GITHUB_STEP_SUMMARY
        fi

    - name: Upload extraction results
      if: success() || failure()
      uses: actions/upload-artifact@v4
      with:
        name: bytehound-analysis
        path: |
          memory-profiling_*.dat.allocations.txt
          memory-profiling_*.dat.json
        retention-days: 7
        if-no-files-found: ignore
