name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always
  RUST_VERSION: "1.90.0"

jobs:
  build-matrix:
    name: ${{ matrix.build-system }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        build-system: [cargo, bazel]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # Cargo build and test
    - name: Cargo Build
      if: matrix.build-system == 'cargo'
      run: cargo build --verbose

    - name: Cargo Test
      if: matrix.build-system == 'cargo'
      run: cargo test --verbose

    # Bazel setup and builds
    - name: Setup Bazel
      if: matrix.build-system == 'bazel'
      uses: bazel-contrib/setup-bazel@0.15.0
      with:
        bazelisk-cache: true
        disk-cache: ${{ runner.os }}-bazel
        repository-cache: true

    - name: Build Core Library (Bazel)
      if: matrix.build-system == 'bazel'
      run: bazel build //src/lib:wsc

    - name: Build Signing Component (Bazel)
      if: matrix.build-system == 'bazel'
      run: bazel build //src/component:signing_lib

    - name: Build CLI Component (Bazel)
      if: matrix.build-system == 'bazel'
      run: bazel build //src/cli:wasmsign_cli

    - name: Validate WASM Components (Bazel)
      if: matrix.build-system == 'bazel'
      run: |
        echo "âœ… Built WASM components:"
        ls -lh bazel-bin/src/component/ || echo "Component artifacts location may vary"
        ls -lh bazel-bin/src/cli/ || echo "CLI artifacts location may vary"
        find bazel-bin -name "*.wasm" -type f | while read wasm_file; do
          echo "Checking $wasm_file"
          file "$wasm_file"
        done

    - name: Upload WASM Artifacts (Bazel)
      if: matrix.build-system == 'bazel'
      uses: actions/upload-artifact@v4
      with:
        name: wasm-components-${{ matrix.os }}
        path: |
          bazel-bin/src/component/**/*.wasm
          bazel-bin/src/cli/**/*.wasm
        retention-days: 7
        if-no-files-found: warn

  # Integration tests for keyless signing (requires OIDC)
  keyless-integration:
    name: Keyless Integration Tests
    runs-on: ubuntu-latest
    permissions:
      id-token: write  # Required for OIDC token
      contents: read
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run Keyless Integration Tests
      run: cargo test --test keyless_integration -- --ignored --nocapture
      env:
        RUST_LOG: debug

  # Rekor verification tests with fresh data
  rekor-verification:
    name: Rekor Verification Tests (Fresh Data)
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Fetch Fresh Rekor Data
      id: update-rekor
      run: |
        ./scripts/update-rekor-test-data.sh > rekor-data.txt 2>&1
        echo "âœ… Fetched fresh Rekor test data"

    - name: Run Rekor Verification Tests
      # Continue even if tests fail - data might be stale or API unavailable
      continue-on-error: true
      run: |
        echo "ğŸ“ Note: These tests use hardcoded data and may fail if not recently updated"
        cargo test signature::keyless::rekor_verifier::tests -- --ignored --nocapture
      env:
        RUST_LOG: debug

    - name: Upload Rekor Data (on failure)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: rekor-fresh-data
        path: rekor-data.txt
        retention-days: 7
